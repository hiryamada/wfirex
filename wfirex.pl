#!/usr/local/bin/perl
use strict;
use warnings;
use Getopt::Std;
use IO::Socket::INET;
use Digest::CRC qw(crc);

my %Ir;
$Ir{'on'} = pack("H*", "221104040504040D040D0404050C050404040504040D04040504040D0404050C0504040D04040504040D040405040404050404040504040D040D0404050C05040404050C0504040D04040504040D0404050404FFFFFF07231005040404050C050C0504040D040405040404050C05040404050C0504040D0404050C05040404050C050404040504040405040404050C050C0504040D04040504040D0404050C05040404050C0504040405");
$Ir{'off'} = pack("H*", "221005040404050C050C0504040D040405040404050C05040404050C0504040D0404050C05040404050C0504040405040404050C050C050C050C0504040D040405040404050C050C05040404050C0504040405FFFFFF07221104040504040D040D0404050C050404040504040D04040504040D0404050C0504040D04040504040D0404050404040504040D040D040D040D0404050C050404040504040D040D04040504040D0404050404");
$Ir{'small'} = pack("H*", "221104040405040D040D0404040D040504040504040D04040405040D0404050C0504040D04040504040D04040405040404050404050C050C050C0504040D04040405040D040D040D04040504040D0404040504FFFFFF08221104040405040D040D0404050C040504040405040D04040405040D0404050C0405040D04040405040D04040504040404050404040D050C050C0504040D04040504040D040D040D04040405040D0404040504");
$Ir{'aoff'} = pack("H*", "211005040404040d0404040d040404040504040c050c040405040404040d040c0405040404040504040405040404040405040404050404040404050c0404050404040405040404040504040c0504040404050404040d040404040504040404050404040c0504040c050c040d040c040d040c04");
$Ir{'study_on'} = pack("H*", "2210050C04050404040405040404050404040405040404050404040D0404040504040405040404050404040D040D040404050404040504040405040C0504040D0404040D040D040C050C0405040C0504040D04040405040404050404040405040404050C050C040D040C050C050C040D040D0404050C040405040404050404040504040C0504040D040C050C050C040D040D0404040D0404050404040504040C050C050C0405040C050C040D040D0404040504FF2E2111040C05040405040404050404040404050404040504040405040C0504040404050404040504040405040D040C040504040405040404050404040D0404050C0405040C050C040D040D0404040D0404050C04050404040504040404050404040504040D040C050C040D040D040C050C040D0404050C040504040405040404050404040D0404040D040D040D040C050C050C0405040C0504040404050404040D040D040C0504040D040C050C050C0405040404FF292111040D04040405040404050404040504040405040404050404040D0404040504040405040404050404040D040D040404050404040504040404050C0405040C0504040D040C050C040D0404050C0405040C05040404050404040504040404050404040D040D040C050C050C040D040C050C0504040D040404040504040405040404050C0504040C050C050C040D040D040C0504040D0404040504040404050C040D040D0404050C040D040C050C0504040404");
$Ir{'study_off'} = pack("H*", "2210040D04050404040504040405040404040504040404050404040D0405040404050404040503050404040D040D040404050404040504040405040C0504040D0404040D040D040C040D0405040C0504040D04040405040404050404040504040405040C050C040D040D040C050C040D040D040C050C04050404040504040405040404050404040D040D040C050C040D040D0404040D0405040404040405040D040D040C0405040C050C040D040D0404040504FF2E2111040D04040405040404050404040504040405040404050404040D0404040504040405040404050404040D040C050404050305040404050404040D0405040C0504040D040C050C040D0404050C0405040C05040404050404040405040404050404040D040D040C050C040D040D040C050C040D040D04040504040405040404050404040504040C050C050C040D040C050C0504040D0404040504040404050C040D040D0404040D040D040C050C0504040404FF292210050C04050404040504040405040404050404040404050404040D0405040404050404040404050404040D040D040404050404040504040405040C0504040D0404040D040D040C050C0405040C0504040D04040405040404050404040405040404050C040D040D040C050C040D040D040D040C050C04050404040405040404050404040504040D040C050C040D040D040D0404040D0404040504040405040D040C040D0405040C040D040D040D0404040504");
$Ir{'study_aoff'} = pack("H*", "2c2b070f0610060f061006050605060f060506050605060406050610060f0605061006050604060506050605060505100610060f06100610060f0610060f060506050605060506040605060506050605060f06100605060f0610060506040605060506050605050506050605061005100610060506040605060506050605050506050610060505100610060505100610060505332d2b0610060f0610061005050605061006050505060506050605060f06100605060f0605060506050605050506050610060f0610061005100610060f06100605060506040605060506050605050506050610060f06050610060f06050605060506050505060506050605060505100610060f06050605060506050505060506050605060f06050610060f06050610060f060506");

$Ir{'aircon_stop'} = pack("H*", "23120404050D04050404040504050404050404050404050404050405040D0405040405040405040405040405040D050D040D04050405040D040504040504040504040504040504050404050404050404050404050405040404050405040405040405040405040405040504040405040504040504040D050D04050404050404050404056423110405040D04050405040405040405040405040405040504040504040D0504040504050404040504050404050D040D040E04040504040D050404050405040404050405040405040405040405040405040504040504040504040504040E0404040504050404050D0404050D040D050404050404050404050405040404050405040D040D050D040D050D0404050D0405040D04050404050404050405040404050405040405040405040405040405040504040405040D050D0405040404050405040405040405040405040405040D040E0404050404050404050404050405040D0405040405040405040504040405040504040504040504040504040504050404040E040405040405040504040405040504040504040D050D04050404050404050404050D0405040D0405040D040D0504040E04");
$Ir{'aircon_jositsu26'} = pack("H*", "02FFFFFFFFFFFFFFFF2601FFFFFFFFFFFF7901FFFFFFFFFF2602FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBE02FFFFFFFFFFFFFFFFFFFFFFFFFFFF4223110504040D05040405040405040405040405040504040504040504040D0504040504040504050404050404050D040D050C05040504040D050404050404050405040405040405040405040405040504040405040504040504040504040504040504050404040504050404050404050404050404050D040D05040405040405040504046423110504050C05040504040504040504050404040504050404050404050D0405040405040404050405040405040D040D050D04050404050D0404050405040404050405040405040405040405040405040504040D0504040504040504050C0504050404050404050D0404050D040D050404050404050405040404050405040405040D040D050D040D050D0404050D0404050D04050404050404050404050405040405040405040405040405040504040405040504040D050D0404050405040405040405040405040405040504040D050D0404050404050404050405040405040D0405040405040504040405040504040504040504040504040504050404050404050D040405040504040405040504040504040504040D050D040504040504040504040504040D050D0405040D040D0504050D04FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF5302FFFFFFFFFFFFA0021202FF7901FFFFFFFFFD02FFFFFFFFFFFFFFFF2602FFFFFFFFD402FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF3702FFCA01");
$Ir{'aircon_reibou26'} = pack("H*", "02FFFFFFFFFFFF0423110504040D05040504040405040504050404040504040504040504050C0504050404050404050404050404050D040D050D04040504050C050405040405040405040405040405040504040504040504040504040504040504040504050404050404050404050404050405040404050405040405040D040D05040504040405040504046423120404050D04040504050404040504050404050404050404050404050D0405040405040405040405040504040D050D040D04050404050D0504040405040405040405040504040405040504040504040504040D050405040404050D040D0504050404040504050D0404050D040D050405030504050404050404050404050404050D040D050D040D050C0504050D0404050D04040504050404050404050404050404050405040503050405040405040405040405040D050D0404050404050404050405040404050405040405040D040D0504050405040404050404050404050D0503050405040405040405040405040405040504040504040504040504040504040D050405040405040405040405040405040504040D050D040405040504040405040504040D050D040405040504040D050D04");

sub crc8_calc {
    my ($buf) = @_;
    return crc($buf, 8, 0, 0, 0, 0x85, 0);
}

our ($opt_v, $opt_s);
getopts('vs') || help();
my $ip = shift || help();
my $command = shift || help();

sub get_wfirex {
    my ($ip) = @_;
    my $sock = IO::Socket::INET->new(
        PeerAddr  => $ip,
        PeerPort  => 60001,
        Proto     => "tcp",
        Timeout   => 5,
        );
    if ($sock) {
        print $sock "\xaa\x00\x01\x18\x50";
        my $buf;
        my $flags;
        $sock->recv($buf, 256, $flags);
        my @data = unpack("CCCCCnnnCC", $buf);
        close($sock);
        my $crc = crc8_calc(substr($buf, 3, length($buf) - 4));
        print join(" ", @data) . " crc:$crc\n" if $opt_v;
        return ($data[7], $data[6], $data[5]);
    }
    return undef;
}

sub send_wfirex {
    my ($ip, $ir) = @_;
    my $len = length($ir);
    $ir = "\x11\x00" . pack("n", $len) . $ir;
    my $crc = pack("C", crc8_calc($ir));
    my $sock = IO::Socket::INET->new(
        PeerAddr  => $ip,
        PeerPort  => 60001,
        Proto     => "tcp",
        Timeout   => 5,
        );
    if ($sock) {        
        print $sock "\xaa" . pack("n", $len+4) . $ir . $crc;
        my $buf;
        my $flags;
        $sock->recv($buf, 256, $flags);
        my @data = unpack("CCCCCC", $buf);
        close($sock);
        my $crc = crc8_calc(substr($buf, 3, length($buf) - 4));
        if (@data) {
            print join(" ", @data) . " crc:$crc\n" if $opt_v;
        }
        return $data[5];
    }
    return undef;
}

if ($command eq "get") {
    my ($il, $te, $hu) = get_wfirex($ip);
    if (defined $il) {
        $te /= 10;
        $hu /= 10;
        #print "il=$il te=$te hu=$hu\n";
        print "{\"temperature\":$te,\"humidity\":$hu,\"illuminance\":$il}\n";
    } else {
        print "wfirex get TIMEOUT $ip\n";
    }
} elsif (defined $Ir{$command}) {
    send_wfirex($ip, $Ir{$command});
} else {
    print "Unknown command $command\n";
    exit 1;
}
exit 0;

sub help {
    print <<EOF;
Usage: wfirex <opt> <IP> <com>
opt:   -v   ; verbose
com: get    ; get sensor value
EOF
    print "     " . join(" ", sort keys %Ir) . "\n";
    exit 1;
}